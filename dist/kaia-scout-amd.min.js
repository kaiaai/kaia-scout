define(["exports"],function(e){"use strict";class t{constructor(){if(this._debug=!1,t._created)throw"Only one instance allowed";t._created=!0}async init(e){e=e||{},this.setSerial(e.serial),this.setEventListener(e.eventListener),this.debug(e.debug),this._initModel(),this._conn.autoDetect=!0,this._cmd={id:-1,active:!1}}setSerial(e){e&&"function"!=typeof e||(this._serial&&this._serial.setEventListener(null),this._serial=e),this._serial&&this._serial.setEventListener(this._serialEventListener)}send(e){if(this._serial)throw"Serial required";return this._issueEvent({event:"write",message:e}),this._debug&&console.log("this._serial.write(text) "+e),this._serial.write(e).err}_serialEventListener(e,t){if(this._issueEvent(t),"disconnected"===t.event)this.connected()&&this._cmd.active&&this._issueEvent({event:"moveError",id:this._cmd.id}),this._cmd.id=-1,this._cmd.active=!1;else if("received"===t.event){let e,s;try{var i="{"+(" "+t.msg).replace(/\r/g,"").replace(/ ([TLRVIflrbtvi])/g,'","$1":"').substr(2)+'"}';e=JSON.parse(i)}catch(e){return}if(!(e.T&&e.L&&e.R&&e.f&&e.l&&e.r&&e.b&&e.t))return;if(s={timeStamp:parseInt(e.T,16),encLeft:this._encToSigned(parseInt(e.L,16)),encRight:this._encToSigned(parseInt(e.R,16)),distForward:parseInt(e.f,16),distLeft:parseInt(e.l,16),distRight:parseInt(e.r,16),distBack:parseInt(e.b,16),distTop:parseInt(e.t,16),cmd:{id:0,active:!1}},e.i)s._cmd.id=parseInt(e.i,16),s._cmd.active=!1;else{if(!e.I)return;s._cmd.id=parseInt(e.I,16),s._cmd.active=!0}e.V&&e.v&&(s.vcc=parseInt(e.V,16),s.fw=e.v),this._issueEvent({event:"parsed",msg:s}),this.connected()?this._cmd.active&&this._cmd.id===s._cmd.id&&!1===s._cmd.active&&(this._cmd.active=!1,this._issueEvent({event:"moveComplete",id:s._cmd.id})):(this._cmd.id=s._cmd.id,this._cmd.active=s._cmd.active),this._model=this._updateModel(this._model,s),this._issueEvent({event:"model",model:this._model})}}setEventListener(e){e&&"function"!=typeof e||(this._listener=e)}debug(e){this._debug=e}_issueEvent(e){this._debug&&console.log("_issueEvent(event) "+JSON.stringify(e)),this._listener&&this._listener(e)}_initModel(){this._model={time:0,dTime:0,dTimeMax:.2,x:0,y:0,heading:0,speed:0,angularSpeed:0,accel:0,angularAccel:0,encLeft:0,encRight:0,dEncLeft:0,dEncRight:0,wheelBase:.165,wheelDia:.065,encPulsesPerRev:297.67,epsilon:1e-4,posValid:!1,speedValid:!1,accValid:!1,default:{speed:.5,brake:!0,p:256,i:16}}}_updateModel(e,t){var i=Object.assign({},e);let s,d,n,a,r,h=Math.PI*e.wheelDia/e.encPulsesPerRev;if(i.time=t.timeStamp/1e6,i.dTime=i.time-e.time,i.encLeft=t.encLeft*h,i.encRight=t.encRight*h,!e.posValid)return i.x=0,i.y=0,i.heading=0,i.speed=0,i.posValid=!0,i.speedValid=!1,i.accValid=!1,i;let c=i.encLeft-e.encLeft,o=i.encRight-e.encRight;if(Math.abs(c-o)<e.epsilon){let t=(c+o)/2;s=t*Math.sin(e.heading),d=t*Math.cos(e.heading),n=0,r=1/0,a=Math.sqrt(Math.pow(s,2)+Math.pow(d,2))}else n=(o-c)/e.wheelBase,s=(r=Math.abs(e.wheelBase*(c/(o-c)+.5)))*(Math.sin(e.heading+n)-Math.sin(e.heading)),d=r*(Math.cos(e.heading)-Math.cos(e.heading+n)),a=r*n;i.dHeading=n,i.dDistance=a,i.heading=e.heading+n,i.x=e.x+s,i.y=e.y+d,i.r=r,i.dTime>i.dTimeMax?(i.speedValid=!1,i.accValid=!1):(i.accValid=i.speedValid,i.speedValid=!0),i.speed=a/i.dTime,i.angularSpeed=n/i.dTime;let l=i.speed-e.speed,u=i.angularSpeed-e.angularSpeed;return i.accel=l/i.dTime,i.angularAccel=u/i.dTime,i}setModel(e){Object.assign(this._model,e)}getModel(){return this._model}turn(e,t,i){if(void 0===e)throw"Angle argument is required";if("number"!=typeof e)throw"Angle must be a number (degrees)";if(void 0===t)t=this._model.default.speed;else if("object"==typeof t){if("object"==typeof i)throw"Speed must be a number";i=t,t=this._model.default.speed}i=i||{};let s=this._model.wheelBase/2,d=i.radius||"oneWheelStationary";if("inPlace"===d)d=0;else if("oneWheelStationary"===d)d=s;else{if("number"!=typeof d)throw"Invalid radius";if(d<0)throw"Radius must be non-negative"}if(0===e)throw"Angle may not be 0";e=e*Math.PI/180;let n,a=Math.sign(e),r=d+a*s,h=d-a*s,c=Math.sign(t),o=Math.abs(e),l=Math.abs(t),u=n=l;return e>0?n=Math.abs(l*h/r):u=Math.abs(l*r/h),i.distance={left:o*c*r,right:o*c*h},i.speed={left:0===i.distance.left?0:u,right:0===i.distance.right?0:n},this.move(i,void 0)}move(e,t){if("number"==typeof(e=e||{})&&(e={distance:e}),"object"!=typeof e)throw"this.move(args[, speed]): args is object or number";let i,s,d=e.distance||0;var n,a;if("number"==typeof e.distance?i=s=e.distance:(s=d.right||0,i=d.left||0),void 0!==t&&(e.speed=t),t=e.speed||0,"number"==typeof e.speed?n=a=e.speed:(n="number"==typeof t.left?t.left:0===i?0:this._model.default.speed,a="number"==typeof t.right?t.right:0===s?0:this._model.default.speed),a>1||a<-1||n>1||n<-1)throw"Relative speed must be within -1.0 ... 1.0";if(0!==s&&a<0||0!==i&&n<0)throw"Speed value must be positive when distance is specified";let r,h,c;0!==i&&(n=Math.abs(n)*Math.sign(i)),0!==s&&(a=Math.abs(a)*Math.sign(s)),!0===e.brake?r=h=!0:(r=(c=e.brake||{}).left||this._model.default.brake,h=c.right||this._model.default.brake);let o=e.p||this._model.default.p||0,l=e.i||this._model.default.i||0,u="L"+(n?this._speedToHex(n):"")+" R"+(a?this._speedToHex(a):"")+" "+(r?"G":"g")+(i?this._distToHex(i):"")+" "+(h?"H":"h")+(s?this._distToHex(s):"")+" ";return e.success=this.connected(),e.success?(0===i&&0===s||(this._cmd.id++,this._cmd.active=!0,u+="i"+this._cmd.id.toString(16),i==s&&(o&&(u+=" P"+o.toString(16)),l&&(u+=" I"+l.toString(16))),u+=" "),e._cmd={id:this._cmd.id},this.send(u),this._issueEvent({event:"move",args:e})):this._issueEvent({event:"moveError",args:e}),e}stop(e){if("object"!=typeof(e=e||{}))throw"this.stop(args) expects object or no argument";let t,i,s,d;!0===e.brake?t=i=!0:(t=(s=e.brake||{}).left||!1,i=s.right||!1),d=(t?"Lffff ":"L ")+(i?"Rffff ":"R "),this.send(d),this._issueEvent({event:"stop",args:e})}_isCmdActive(){return this._cmd.active}connected(){return-1!==this._cmd.id}_encToSigned(e){return 2147483648&e?e-4294967296:e}_stopToSpeed(e){return e?"FF00":""}_speedToHex(e){return 0===e?"":((e=Math.round(255*e))>=0?e:65536+e).toString(16)}_distToHex(e){return 0===e?"":((e=Math.round(e*this._model.encPulsesPerRev/(Math.PI*this._model.wheelDia)))>=0?e:4294967296+e).toString(16)}}let i;t._created=!1,e.Scout=t,e.createScout=async function(e){return i?Promise.resolve(i):(i=new t).init(e)},Object.defineProperty(e,"__esModule",{value:!0})});