var kaiaScoutJs=function(e){"use strict";class t{constructor(){if(this._resolveFunc=null,this._rejectFunc=null,this._debug=!1,t._created)throw"Only one instance allowed";t._created=!0}async init(e){return e=e||{},this.serial(e.serial),this.setEventListener(e.eventListener),this.debug(e.debug),this._initModel(),this._conn.autoDetect=!0,this._cmd={id:-1,active:!1},this._makePromise()}serial(e){return e&&"function"!=typeof e||(this._serial&&this._serial.setEventListener(null),this._serial=e),this._serial&&this._serial.setEventListener(this._serialEventListener),this._serial}send(e){if(this._serial)throw"Serial required";return this._issueEvent({event:"write",message:e,err:!1}),this._debug&&console.log("this._serial.write(text) "+e),this._serial.write(e).err}_serialEventListener(e,t){if(this._issueEvent(t),"usbDeviceDisconnected"===t.event)this.connected()&&this._cmd.active&&this._issueEvent({event:"moveError",err:"Disconnected",id:this._cmd.id}),this._cmd.id=-1,this._cmd.active=!1,this._reject("Disconnected");else if("received"===t.event){let e,i;try{let i="{"+(" "+t.message).replace(/\r/g,"").replace(/ ([TLRVIflrbtvi])/g,'","$1":"').substr(2)+'"}';e=JSON.parse(i)}catch(e){return}if(!(e.T&&e.L&&e.R&&e.f&&e.l&&e.r&&e.b&&e.t))return;if(i={timeStamp:parseInt(e.T,16),encLeft:this._encToSigned(parseInt(e.L,16)),encRight:this._encToSigned(parseInt(e.R,16)),distForward:parseInt(e.f,16),distLeft:parseInt(e.l,16),distRight:parseInt(e.r,16),distBack:parseInt(e.b,16),distTop:parseInt(e.t,16),cmd:{id:0,active:!1}},e.i)i._cmd.id=parseInt(e.i,16),i._cmd.active=!1;else{if(!e.I)return;i._cmd.id=parseInt(e.I,16),i._cmd.active=!0}e.V&&e.v&&(i.vcc=parseInt(e.V,16),i.fw=e.v),this._issueEvent({event:"parsed",message:i,err:!1}),this.connected()?this._cmd.active&&this._cmd.id===i._cmd.id&&!1===i._cmd.active&&(this._cmd.active=!1,this._issueEvent({event:"moveComplete",id:i._cmd.id,err:!1}),this._resolve(this)):(this._cmd.id=i._cmd.id,this._cmd.active=i._cmd.active,this._issueEvent({event:"connected",err:!1,id:this._cmd.id}),this._resolve(this)),this._issueEvent({event:"modelUpdating",model:this._model,err:!1}),this._model=this._updateModel(this._model,i),this._issueEvent({event:"modelUpdated",model:this._model,err:!1})}}setEventListener(e){e&&"function"!=typeof e||(this._listener=e)}debug(e){this._debug=e}_issueEvent(e){this._debug&&console.log("_issueEvent(event) "+JSON.stringify(e)),this._listener&&this._listener(e.err,e)}_initModel(){this._model={time:0,dTime:0,dTimeMax:.2,x:0,y:0,heading:0,speed:0,angularSpeed:0,accel:0,angularAccel:0,encLeft:0,encRight:0,dEncLeft:0,dEncRight:0,wheelBase:.165,wheelDia:.065,encPulsesPerRev:297.67,epsilon:1e-4,posValid:!1,speedValid:!1,accValid:!1,default:{speed:.5,brake:!0,p:256,i:16}}}_updateModel(e,t){let i,s,n,r,d,a=Object.assign({},e),h=Math.PI*e.wheelDia/e.encPulsesPerRev;if(a.time=t.timeStamp/1e6,a.dTime=a.time-e.time,a.encLeft=t.encLeft*h,a.encRight=t.encRight*h,!e.posValid)return a.x=0,a.y=0,a.heading=0,a.speed=0,a.posValid=!0,a.speedValid=!1,a.accValid=!1,a;let l=a.encLeft-e.encLeft,c=a.encRight-e.encRight;if(Math.abs(l-c)<e.epsilon){let t=(l+c)/2;i=t*Math.sin(e.heading),s=t*Math.cos(e.heading),n=0,d=1/0,r=Math.sqrt(Math.pow(i,2)+Math.pow(s,2))}else n=(c-l)/e.wheelBase,i=(d=Math.abs(e.wheelBase*(l/(c-l)+.5)))*(Math.sin(e.heading+n)-Math.sin(e.heading)),s=d*(Math.cos(e.heading)-Math.cos(e.heading+n)),r=d*n;a.dHeading=n,a.dDistance=r,a.heading=e.heading+n,a.x=e.x+i,a.y=e.y+s,a.r=d,a.dTime>a.dTimeMax?(a.speedValid=!1,a.accValid=!1):(a.accValid=a.speedValid,a.speedValid=!0),a.speed=r/a.dTime,a.angularSpeed=n/a.dTime;let o=a.speed-e.speed,u=a.angularSpeed-e.angularSpeed;return a.accel=o/a.dTime,a.angularAccel=u/a.dTime,a}model(e){return e&&(this._model=e),this._model}turn(e,t,i){if(void 0===e)throw"Angle argument is required";if("number"!=typeof e)throw"Angle must be a number (degrees)";if(void 0===t)t=this._model.default.speed;else if("object"==typeof t){if("object"==typeof i)throw"Speed must be a number";i=t,t=this._model.default.speed}i=i||{};let s=this._model.wheelBase/2,n=i.radius||"oneWheelStationary";if("inPlace"===n)n=0;else if("oneWheelStationary"===n)n=s;else{if("number"!=typeof n)throw"Invalid radius";if(n<0)throw"Radius must be non-negative"}if(0===e)throw"Angle may not be 0";e=e*Math.PI/180;let r,d=Math.sign(e),a=n+d*s,h=n-d*s,l=Math.sign(t),c=Math.abs(e),o=Math.abs(t),u=r=o;return e>0?r=Math.abs(o*h/a):u=Math.abs(o*a/h),i.distance={left:c*l*a,right:c*l*h},i.speed={left:0===i.distance.left?0:u,right:0===i.distance.right?0:r},this.move(i,void 0)}move(e,t){if("number"==typeof(e=e||{})&&(e={distance:e}),"object"!=typeof e)throw"this.move(args[, speed]): args is object or number";let i,s,n,r,d,a,h,l=e.distance||0;if("number"==typeof e.distance?i=s=e.distance:(s=l.right||0,i=l.left||0),void 0!==t&&(e.speed=t),t=e.speed||0,"number"==typeof e.speed?n=r=e.speed:(n="number"==typeof t.left?t.left:0===i?0:this._model.default.speed,r="number"==typeof t.right?t.right:0===s?0:this._model.default.speed),r>1||r<-1||n>1||n<-1)throw"Relative speed must be within -1.0 ... 1.0";if(0!==s&&r<0||0!==i&&n<0)throw"Speed value must be positive when distance is specified";0!==i&&(n=Math.abs(n)*Math.sign(i)),0!==s&&(r=Math.abs(r)*Math.sign(s)),!0===e.brake?d=a=!0:(d=(h=e.brake||{}).left||this._model.default.brake,a=h.right||this._model.default.brake);let c=e.p||this._model.default.p||0,o=e.i||this._model.default.i||0,u="L"+(n?this._speedToHex(n):"")+" R"+(r?this._speedToHex(r):"")+" "+(d?"G":"g")+(i?this._distToHex(i):"")+" "+(a?"H":"h")+(s?this._distToHex(s):"")+" ";if(e.success=this.connected(),!e.success)throw"Invalid parameters";return 0===i&&0===s||(this._cmd.id++,this._cmd.active=!0,u+="i"+this._cmd.id.toString(16),i==s&&(c&&(u+=" P"+c.toString(16)),o&&(u+=" I"+o.toString(16))),u+=" "),e._cmd={id:this._cmd.id},this.send(u),this._issueEvent({event:"move",args:e,err:!1}),this._makePromise()}stop(e){if("object"!=typeof(e=e||{}))throw"Invalid arguments";let t,i,s,n;return!0===e.brake?t=i=!0:(t=(s=e.brake||{}).left||!1,i=s.right||!1),n=(t?"Lffff ":"L ")+(i?"Rffff ":"R "),this.send(n),this._issueEvent({event:"stop",args:e,err:!1}),Promise.resolve(this)}busy(){return this._cmd.active}connected(){return-1!==this._cmd.id}_encToSigned(e){return 2147483648&e?e-4294967296:e}_stopToSpeed(e){return e?"FF00":""}_speedToHex(e){return 0===e?"":((e=Math.round(255*e))>=0?e:65536+e).toString(16)}_distToHex(e){return 0===e?"":((e=Math.round(e*this._model.encPulsesPerRev/(Math.PI*this._model.wheelDia)))>=0?e:4294967296+e).toString(16)}_clearCallback(){this._resolveFunc=null,this._rejectFunc=null}_resolve(e){let t=this._resolveFunc;this._clearCallback(),null!==t&&t(e)}_reject(e){let t=this._rejectFunc;this._clearCallback(),null!==t&&t(e)}_makePromise(){return new Promise((e,t)=>{this._resolveFunc=e,this._rejectFunc=t})}}let i;return t._created=!1,e.Scout=t,e.createScout=async function(e){return i?Promise.resolve(i):(i=new t).init(e)},e}({});
